===============================================================================
PURPLESKY: LONE CHAMPION - OPERATIONAL MANUAL
===============================================================================
Version: 2.1 (Ultra-Precision Hardened Edition)
System: Sofia Lone Champion - High-Fidelity Execution Engine
Role: Directional Liquidity Provider (Mean Reversion)

1. SYSTEM OVERVIEW
------------------
PurpleSky is a professional quantitative trading system designed for Bybit 
Linear Perpetuals. It employs LightGBM models and Orderbook Microstructure 
analysis to provide liquidity (Maker orders) at high-probability reversal points.

The "Lone Champion" runner is optimized for single-symbol execution with 
extremely high synchronization between local state and exchange reality.

2. CORE FEATURES
----------------
* Maker-Only Strategy: Strictly uses PostOnly orders to minimize fees and capture 
  the bid-ask spread.
* Deep Bootstrap (New in 2.1): Automatically fetches ~30 days (10,000 bars) of 
  paginated historical data on startup. This ensures that Macro features 
  (Volume Z-Scores, long-term ATR) are high-fidelity from the first bar.
* Advanced Alpha: Computes ~40 live features, including:
    - Orderbook Imbalance Trend
    - Micro-Price Pressure (Normalized)
    - Liquidity Elasticity (Bid/Ask Slopes)
    - Maker Uncertainty (Micro-Price Volatility)
* Precision Logging (2.1): Feature input vectors are now logged with 6-decimal 
  precision to allow monitoring of very small microstructure changes.
* Dynamic Position Sizing: Live ATR-based risk management scaled by account equity.
* Automated Lifecycle: Logic handles Signal -> Limit Entry -> TP/SL Management -> 
  Position Timeout -> PnL Attribution.

3. ROBUSTNESS & SAFETY LAYERS
-----------------------------
The system includes multiple "Mission-Critical" defenses:

* Atomic State Persistence: Uses a "Write-Sync-Swap" protocol. State is written 
  to a temporary file, flushed to disk (fsync), and atomically renamed. 
  Prevents bot_state corruption during power loss or crashes.
* Local Time Authority (Enhanced in 2.1): Position duration is tracked using 
  synchronized "Exchange-Relative" time. At startup, the bot calculates the 
  drift vs Bybit Server and applies this offset. In Version 2.1, the bot now 
  re-calibrates this sync every 1 hour to handle evolving system clock drift.
* Expert Reconciliation (10s Sync): Fast synchronization every 10 seconds. 
  Detects "Drift" (if you move an order manually on the UI), cleans up "Zombie" 
  orders, and adopts "Orphans" after a restart.
* Hardened PnL Detection (New in 2.1): When a position closes, the bot uses a 
  30-second "Safety Buffer" lookback. This ensures that no PnL records are 
  missed due to network latency or timestamp misalignments between the 
  exchange and local machine.
* PnL Aggregation: Robustly sums all partial fills for a trade cycle. It filters 
  Bybit records by timestamp to ensure local PnL matches actual wallet growth.
* Friction Tracking (Refined in 2.1): Monitors "Wallet Drift" live. In Version 2.1, 
  Friction is anchored to the "Total Balance" (Cash) instead of Equity. 
  This prevents the friction metric from fluctuating while a trade is open 
  and reveals the true lifetime cost of fees, funding, and slippage.
* Graceful Termination: Supports SIGINT/SIGTERM. Saves state and notifies 
  Discord before exiting, whether on Windows (Ctrl+C) or Linux (kill/docker stop).

4. REQUIREMENTS & SETUP
-----------------------
* Python: 3.10 or higher.
* Key Dependencies: pandas, numpy, joblib, lightgbm, pybit (vendored).
* Environment: Windows or Linux. (Version 2.1 uses explicitly UTC-safe logic 
  and modern timezone-aware datetime calls).

ENVIRONMENT VARIABLES (Required in secrets.bat or system env):
- BYBIT_API_KEY: Your API Key.
- BYBIT_API_SECRET: Your API Secret.
- DISCORD_WEBHOOK_URL: (Optional) URL for real-time mobile/desktop alerts.

DISCORD ALERTS SETUP:
1. Go to Discord -> Server Settings -> Integrations -> Webhooks.
2. Create "New Webhook" and copy the URL.
3. Set the DISCORD_WEBHOOK_URL variable in your environment.
The bot will alert on: Startup, Fills, Kill-Switch trigger, and Crashes.

5. STARTUP SAFETY GATES
-----------------------
Upon launch, the bot MUST pass these checks or it will Hard-Exit:
1. Time Sync: Initial calibration of clock drift vs Bybit Server. (Version 2.1 
   re-checks this every hour automatically).
2. Mode Enforcement: Forces account into "One-Way Mode" (Mode 0) for the symbol.
3. Margin Audit: Logs Margin Mode (Isolated/Cross) and Unified status.
4. Instrument Check: Verifies symbol status and fetches tick/lot size rules.

6. HOW TO USE
-------------
WINDOWS (WATCHDOG MODE):
Execute the provided .bat script (e.g., .\RAVEUSDT_Trader_MAIN.bat).

MANUAL CLI:
python live_trader.py --symbol <SYMBOL> --model-root <PATH_TO_MODEL_FOLDER>

HEARTBEAT MONITORING:
Every 30s, the bot logs a reality check.
Format (Version 2.1):
[HEARTBEAT] Price: 0.45 | Pos: 100 | Eq: $105.00 | Unreal: $1.00 | Friction: -0.05
- Eq: Total account equity.
- Unreal: Current floating profit/loss of the open position.
- Friction: Lifetime hidden costs. Negative means you are paying fees/funding. 
- In Version 2.1, Friction stays stable while positions are open.

7. GOOD PRACTICES
-----------------
* Model Transitions: Always check the [FEATURES] block in the logs after 
  updating a model to ensure feature inputs look sane.
* Time Sync: Ensure "Set time automatically" is enabled on your OS.
* Isolation: Use one bot instance per Bybit Sub-Account/Symbol to avoid 
  conflicting position states.
* Fresh History: If you suspect data corruption, delete the history CSV. 
  The 2.1 Deep Bootstrap will rebuild the last 30 days of data correctly.
* Dry Run: Remove API keys to run the bot in "Dry Mode" for testing new models 
  without financial risk.

8. TROUBLESHOOTING UTILITIES
----------------------------
Included diagnostic scripts in the root directory:
- debug_position.py: Inspect raw exchange timestamps and holding times.
- debug_pnl.py: Deep-dive into fill fragmentation and fee reporting.
- debug_mode_switch.py: Verify account position mode settings.

9. REGIME & CONCEPT DRIFT DETECTION
-----------------------------------
The system includes a dedicated Health Monitor to detect when live market 
conditions deviate from the model's "training reality":

* Orderbook Elasticity (Structural Drift): 
  The bot monitors 'ob_bid_slope_mean' against a rolling 24-hour baseline. 
  If the current slope shifts by >3 standard deviations (Drift Z), the 
  system flags a "CRITICAL DRIFT". This indicates the orderbook structure 
  is fundamentally different (e.g., thinner or more fragile) than what 
   the model learned.

* Sentiment Pinning: 
  The bot tracks the average model confidence over a 1-hour window. 
  - PINNED BULLISH/BEARISH: If the average confidence stays above 0.75 
    or below 0.25 for an hour, it suggests the market is in a runaway 
    trend that the mean-reversion model is not designed to handle.

* Rolling Win Rate (Outcome Drift):
  Monitors the success rate of the last 20 trades.
  - HEALTHY: WR > 50%
  - WARNING: WR < 50% (Potential early drift)
  - CRITICAL: WR < 40% (Model is likely no longer predictive in the 
    current regime).

Watch for the [DIAG] and Health: tags in the logs to monitor these values.

===============================================================================
PURPLESKY TRADING SYSTEM | Engineered for Robustness.
===============================================================================