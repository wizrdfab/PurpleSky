<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Live Trading Dashboard</title>
  <style>
    :root {
      --bg1: #0f172a;
      --bg2: #111827;
      --panel: #0b1220;
      --accent: #22c55e;
      --accent2: #f59e0b;
      --danger: #ef4444;
      --muted: #94a3b8;
      --text: #e5e7eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Space Grotesk", "Bahnschrift", "Trebuchet MS", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% 10%, #0b1430 0%, transparent 60%),
                  radial-gradient(1200px 600px at 90% 20%, #1b2a3a 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      min-height: 100vh;
    }
    header {
      padding: 28px 32px 10px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 16px;
    }
    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.5px;
    }
    h2 {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.3px;
    }
    .sub {
      color: var(--muted);
      font-size: 13px;
      margin-top: 6px;
    }
    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 12px;
      color: var(--muted);
    }
    .summary-grid {
      padding: 0 32px 16px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .summary-card {
      background: linear-gradient(180deg, rgba(11,18,32,0.95), rgba(11,18,32,0.85));
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 14px;
      padding: 12px;
      cursor: pointer;
      transition: transform 0.15s ease, border 0.15s ease;
    }
    .summary-card:hover { transform: translateY(-2px); }
    .summary-card.selected {
      border-color: rgba(34,197,94,0.6);
      box-shadow: 0 0 0 2px rgba(34,197,94,0.2);
    }
    .summary-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
    }
    .badge.ok { color: var(--accent); }
    .badge.warn { color: var(--accent2); }
    .badge.bad { color: var(--danger); }
    .summary-value {
      font-size: 18px;
      font-weight: 600;
    }
    .row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      padding: 3px 0;
      border-bottom: 1px dashed rgba(148,163,184,0.1);
    }
    .row:last-child { border-bottom: none; }
    .ok { color: var(--accent); }
    .warn { color: var(--accent2); }
    .bad { color: var(--danger); }
    .muted { color: var(--muted); }
    .detail-wrap {
      padding: 12px 32px 40px;
    }
    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 10px;
      gap: 12px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .feature-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px 8px;
      font-size: 11px;
      max-height: 220px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .feature-item {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .truncate {
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      display: block;
    }
    .card {
      background: linear-gradient(180deg, rgba(11,18,32,0.95), rgba(11,18,32,0.85));
      border: 1px solid rgba(148,163,184,0.15);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .card h3 {
      margin: 0 0 10px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }
    .value {
      font-size: 24px;
      font-weight: 600;
    }
    canvas {
      width: 100%;
      height: 80px;
      margin-top: 8px;
    }
    .chart-large {
      height: 300px;
    }
    .nav-tabs {
      padding: 0 32px 8px;
      display: flex;
      gap: 8px;
    }
    .nav-btn {
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      transition: all 0.15s ease;
    }
    .nav-btn.active {
      color: var(--text);
      border-color: rgba(34,197,94,0.6);
      box-shadow: 0 0 0 2px rgba(34,197,94,0.15);
    }
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    .account-header {
      padding: 12px 32px 0;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 16px;
    }
    .account-grid {
      padding: 12px 32px 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
    }
    .account-chart {
      margin: 16px 32px;
      position: relative;
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 12px;
    }
    .chart-controls {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }
    .toggle-group {
      display: flex;
      gap: 6px;
    }
    .toggle-btn {
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 11px;
      transition: all 0.15s ease;
    }
    .toggle-btn.active {
      color: var(--text);
      border-color: rgba(34,197,94,0.6);
      box-shadow: 0 0 0 2px rgba(34,197,94,0.15);
    }
    .range-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .range-btn {
      border: 1px solid rgba(148,163,184,0.2);
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 11px;
    }
    .range-btn.active {
      color: var(--text);
      border-color: rgba(56,189,248,0.6);
      box-shadow: 0 0 0 2px rgba(56,189,248,0.15);
    }
    .legend {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .legend span::before {
      content: "";
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      margin-right: 6px;
      vertical-align: middle;
    }
    .legend .raw::before { background: #38bdf8; }
    .legend .adjusted::before { background: #22c55e; }
    .legend .inactive {
      color: rgba(148,163,184,0.6);
    }
    .profile-list {
      display: grid;
      gap: 6px;
      font-size: 12px;
    }
    .profile-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      border-bottom: 1px dashed rgba(148,163,184,0.12);
      padding-bottom: 4px;
    }
    .profile-row:last-child {
      border-bottom: none;
      padding-bottom: 0;
    }
    .profile-meta {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .profile-metrics {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
    }
    .profile-spark {
      width: 120px;
      height: 26px;
    }
    .tooltip {
      position: absolute;
      display: none;
      pointer-events: none;
      background: rgba(15, 23, 42, 0.92);
      border: 1px solid rgba(148, 163, 184, 0.25);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Live Trading Dashboard</h1>
      <div class="sub" id="subline">Waiting for metrics...</div>
    </div>
    <div class="pill" id="statusPill">Offline</div>
  </header>

  <nav class="nav-tabs">
    <button class="nav-btn active" id="tabAccount" data-view="account">Account Balance</button>
    <button class="nav-btn" id="tabTraders" data-view="traders">Traders</button>
  </nav>

  <section id="accountSection" class="section active">
    <div class="account-header">
      <div>
        <h2>Account Balance</h2>
        <div class="sub" id="accountSub">Waiting for balance updates...</div>
      </div>
      <div class="pill" id="accountStatus">--</div>
    </div>
    <div class="account-grid">
      <div class="card">
        <h3>Total Balance</h3>
        <div class="value" id="aggBalance">--</div>
        <div class="row"><span>Available</span><span id="aggAvailable">--</span></div>
        <div class="row"><span>Profiles</span><span id="aggProfiles">--</span></div>
      </div>
      <div class="card">
        <h3>Unified Account</h3>
        <div class="value" id="aggUnified">--</div>
        <div class="row"><span>Share</span><span id="aggUnifiedShare">--</span></div>
        <div class="row"><span>Updated</span><span id="aggUpdated">--</span></div>
      </div>
      <div class="card">
        <h3>Funding Account</h3>
        <div class="value" id="aggFunding">--</div>
        <div class="row"><span>Share</span><span id="aggFundingShare">--</span></div>
        <div class="row"><span>Flow Events</span><span id="aggFlows">--</span></div>
      </div>
      <div class="card">
        <h3>Performance</h3>
        <div class="value" id="aggReturn">--</div>
        <div class="row"><span>Max DD</span><span id="aggMaxDD">--</span></div>
        <div class="row"><span>Volatility</span><span id="aggVolatility">--</span></div>
        <div class="row"><span>Stability</span><span id="aggStability">--</span></div>
      </div>
    </div>
    <div class="card account-chart">
      <div class="chart-header">
        <div>
          <h3>Balance Curve (Raw + Flow-Adjusted)</h3>
          <div class="sub" id="balanceNote">Flow-adjusted removes large deposits/withdrawals.</div>
        </div>
        <div class="chart-controls">
          <div class="range-group" id="balanceRange">
            <button class="range-btn active" data-range="all">All</button>
            <button class="range-btn" data-range="7d">7D</button>
            <button class="range-btn" data-range="24h">24H</button>
            <button class="range-btn" data-range="6h">6H</button>
            <button class="range-btn" data-range="1h">1H</button>
          </div>
          <div class="range-group" id="balanceScale">
            <button class="range-btn active" data-scale="split">Split Scale</button>
            <button class="range-btn" data-scale="shared">Shared Scale</button>
          </div>
          <div class="toggle-group" id="balanceToggle">
            <button class="toggle-btn active" data-toggle="raw">Raw Curve</button>
            <button class="toggle-btn active" data-toggle="adjusted">Flow-Adjusted</button>
          </div>
        </div>
      </div>
      <canvas id="balanceChart" class="chart-large"></canvas>
      <div id="balanceTooltip" class="tooltip"></div>
      <div class="legend">
        <span class="raw">Raw</span>
        <span class="adjusted">Flow-adjusted</span>
      </div>
    </div>
    <div class="account-grid">
      <div class="card">
        <h3>Curve Diagnostics</h3>
        <div class="row"><span>Smoothness</span><span id="aggSmoothness">--</span></div>
        <div class="row"><span>Trend / Day</span><span id="aggTrend">--</span></div>
        <div class="row"><span>Raw Return</span><span id="aggRawReturn">--</span></div>
        <div class="row"><span>Points</span><span id="aggPoints">--</span></div>
      </div>
      <div class="card">
        <h3>Profiles</h3>
        <div class="profile-list" id="accountProfiles">--</div>
      </div>
    </div>
  </section>

  <section id="tradersSection" class="section">
    <section class="summary-grid" id="summaryGrid"></section>
    <section class="detail-wrap">
      <div class="detail-header">
        <div>
          <h2 id="detailTitle">Select a symbol</h2>
          <div class="sub" id="detailSub">No data loaded</div>
        </div>
        <div class="pill" id="detailStatus">--</div>
      </div>
      <div class="grid">
        <div class="card">
          <h3>Equity and PnL</h3>
          <div class="value" id="equityVal">--</div>
          <div class="row"><span>Daily PnL</span><span id="dailyPnl">--</span></div>
          <div class="row"><span>Unrealized</span><span id="unrealPnl">--</span></div>
          <canvas id="equityChart"></canvas>
        </div>
        <div class="card">
          <h3>Position</h3>
          <div class="value" id="posSide">--</div>
          <div class="row"><span>Size</span><span id="posSize">--</span></div>
          <div class="row"><span>Entry</span><span id="posEntry">--</span></div>
          <div class="row"><span>Mark</span><span id="posMark">--</span></div>
          <div class="row"><span>TP / SL</span><span id="posTPSL">--</span></div>
        </div>
        <div class="card">
          <h3>Health</h3>
          <div class="value" id="healthVal">--</div>
          <div class="row"><span>Sentiment</span><span id="sentimentVal">--</span></div>
          <div class="row"><span>Regime</span><span id="regimeVal">--</span></div>
          <div class="row"><span>Trade Enabled</span><span id="tradeEnabled">--</span></div>
          <div class="row"><span>Drift Alerts</span><span id="driftAlerts">--</span></div>
        </div>
        <div class="card">
          <h3>Model</h3>
          <div class="value" id="modelPred">--</div>
          <div class="row"><span>Pred Long</span><span id="predLong">--</span></div>
          <div class="row"><span>Pred Short</span><span id="predShort">--</span></div>
          <div class="row"><span>Threshold</span><span id="predThreshold">--</span></div>
          <div class="row"><span>Bar Time</span><span id="predBar">--</span></div>
          <div class="row"><span>Model Path</span><span class="truncate" id="modelPath">--</span></div>
          <div class="row"><span>Keys Profile</span><span id="keysProfile">--</span></div>
        </div>
        <div class="card">
          <h3>Data Quality</h3>
          <div class="value" id="barsVal">--</div>
          <div class="row"><span>Macro %</span><span id="macroPct">--</span></div>
          <div class="row"><span>OB Density</span><span id="obDensity">--</span></div>
          <div class="row"><span>Trade Continuity</span><span id="tradeCont">--</span></div>
          <div class="row"><span>Lag Trade / Bar</span><span id="lagTradeBar">--</span></div>
        </div>
        <div class="card">
          <h3>Latency</h3>
          <div class="value" id="restLatency">--</div>
          <div class="row"><span>WS Trade</span><span id="wsTrade">--</span></div>
          <div class="row"><span>WS OB</span><span id="wsOb">--</span></div>
          <div class="row"><span>OB Lag</span><span id="obLag">--</span></div>
          <canvas id="latencyChart"></canvas>
        </div>
        <div class="card">
          <h3>Orders</h3>
          <div class="value" id="openOrders">--</div>
          <div class="row"><span>Last Reconcile</span><span id="lastReconcile">--</span></div>
          <div class="row"><span>Source</span><span id="reconcileSource">--</span></div>
          <div class="row"><span>Protective</span><span id="protectiveCount">--</span></div>
        </div>
        <div class="card">
          <h3>Errors</h3>
          <div class="value" id="errorCount">--</div>
          <div class="row"><span>Last Runtime</span><span id="lastRuntime">--</span></div>
          <div class="row"><span>Last API</span><span id="lastApi">--</span></div>
        </div>
        <div class="card">
          <h3>Features</h3>
          <div class="feature-grid" id="featureList">--</div>
        </div>
      </div>
    </section>
  </section>

  <script>
    const fmt = (v, d=2) => (v === null || v === undefined) ? "--" : Number(v).toFixed(d);
    const fmtPct = (v) => (v === null || v === undefined) ? "--" : `${Number(v).toFixed(1)}%`;
    const fmtSec = (v) => (v === null || v === undefined) ? "--" : `${Number(v).toFixed(1)}s`;
    const fmtMs = (v) => (v === null || v === undefined) ? "--" : `${Number(v).toFixed(1)}ms`;

    const state = {
      selected: null,
      latestMap: {},
      items: [],
      lastHistorySymbol: null,
      view: "account",
      balanceRange: "all",
      balanceScale: "split",
      balanceShowRaw: true,
      balanceShowAdjusted: true,
      balanceHistory: [],
      balanceFlowPct: 2.0,
      balancePlot: null,
      balanceLatest: null
    };

    function sparkline(canvas, values, color) {
      const ctx = canvas.getContext("2d");
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, w, h);
      if (!values.length) return;
      const min = Math.min(...values);
      const max = Math.max(...values);
      const span = (max - min) || 1;
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      values.forEach((v, i) => {
        const x = (i / (values.length - 1)) * w;
        const y = h - ((v - min) / span) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    function parseTs(ts) {
      if (!ts) return null;
      const iso = ts.replace(" ", "T") + "Z";
      const ms = Date.parse(iso);
      return Number.isNaN(ms) ? null : ms;
    }

    function drawBalanceChart(canvas, rawSeries, adjustedSeries, scaleMode, showRaw, showAdjusted) {
      const ctx = canvas.getContext("2d");
      const w = canvas.width = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;
      ctx.clearRect(0, 0, w, h);
      const activeRaw = showRaw ? rawSeries : [];
      const activeAdj = showAdjusted ? adjustedSeries : [];
      const combined = [...activeRaw, ...activeAdj];
      if (!combined.length) return;
      const pad = 10;
      const scaleX = (i, n) => (n <= 1 ? pad : (i / (n - 1)) * (w - pad * 2) + pad);

      const rawMin = activeRaw.length ? Math.min(...activeRaw) : combined[0];
      const rawMax = activeRaw.length ? Math.max(...activeRaw) : combined[0];
      const adjMin = activeAdj.length ? Math.min(...activeAdj) : combined[0];
      const adjMax = activeAdj.length ? Math.max(...activeAdj) : combined[0];
      const combinedMin = Math.min(rawMin, adjMin);
      const combinedMax = Math.max(rawMax, adjMax);

      const useShared = (scaleMode || "shared") === "shared";
      const minRaw = useShared ? combinedMin : rawMin;
      const maxRaw = useShared ? combinedMax : rawMax;
      const minAdj = useShared ? combinedMin : adjMin;
      const maxAdj = useShared ? combinedMax : adjMax;

      const spanRaw = (maxRaw - minRaw) || 1;
      const spanAdj = (maxAdj - minAdj) || 1;
      const scaleYRaw = (v) => h - pad - ((v - minRaw) / spanRaw) * (h - pad * 2);
      const scaleYAdj = (v) => h - pad - ((v - minAdj) / spanAdj) * (h - pad * 2);

      const drawGrid = () => {
        const lines = 4;
        ctx.strokeStyle = "rgba(148,163,184,0.12)";
        ctx.lineWidth = 1;
        for (let i = 0; i <= lines; i++) {
          const val = maxRaw - ((maxRaw - minRaw) * (i / lines));
          const y = scaleYRaw(val);
          ctx.beginPath();
          ctx.moveTo(pad, y);
          ctx.lineTo(w - pad, y);
          ctx.stroke();
        }
      };

      const drawLine = (series, color, scaleY) => {
        if (!series || !series.length) return;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        series.forEach((v, i) => {
          const x = scaleX(i, series.length);
          const y = scaleY(v);
          if (i === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      };

      drawGrid();
      if (showRaw) {
        drawLine(rawSeries, "#38bdf8", scaleYRaw);
      }
      if (showAdjusted) {
        drawLine(adjustedSeries, "#22c55e", scaleYAdj);
      }

      ctx.fillStyle = "rgba(148,163,184,0.8)";
      ctx.font = "11px Space Grotesk, sans-serif";
      const rawLabel = `Raw ${fmt(maxRaw, 2)} / ${fmt(minRaw, 2)}`;
      ctx.fillText(rawLabel, pad, pad + 2);
      if (!useShared) {
        const adjLabel = `Adj ${fmt(maxAdj, 2)} / ${fmt(minAdj, 2)}`;
        const textWidth = ctx.measureText(adjLabel).width;
        ctx.fillText(adjLabel, w - textWidth - pad, pad + 2);
      }
    }

    function setupBalanceTooltip() {
      const canvas = document.getElementById("balanceChart");
      const tooltip = document.getElementById("balanceTooltip");
      if (!canvas || !tooltip) return;

      canvas.addEventListener("mousemove", (evt) => {
        if (!state.balancePlot) return;
        const rect = canvas.getBoundingClientRect();
        const cardRect = canvas.parentElement.getBoundingClientRect();
        const x = evt.clientX - rect.left;
        const n = state.balancePlot.raw.length;
        const idx = Math.min(n - 1, Math.max(0, Math.round((x / rect.width) * (n - 1))));
        const raw = state.balanceShowRaw ? state.balancePlot.raw[idx] : null;
        const adj = state.balanceShowAdjusted ? state.balancePlot.adjusted[idx] : null;
        const ts = state.balancePlot.labels[idx];
        let timeText = "--";
        if (ts) {
          const parsed = parseTs(ts);
          if (parsed) {
            timeText = new Date(parsed).toLocaleString();
          }
        }
        tooltip.style.display = "block";
        const parts = [];
        if (raw !== null && raw !== undefined) {
          parts.push(`Raw: ${fmt(raw, 4)}`);
        }
        if (adj !== null && adj !== undefined) {
          parts.push(`Adj: ${fmt(adj, 4)}`);
        }
        tooltip.textContent = `${timeText} | ${parts.length ? parts.join(" | ") : "No series visible"}`;
        const left = Math.min(cardRect.width - tooltip.offsetWidth - 8, Math.max(8, (rect.left - cardRect.left) + x + 12));
        tooltip.style.left = `${left}px`;
        tooltip.style.top = `${Math.max(8, (rect.top - cardRect.top) + (evt.clientY - rect.top) - 24)}px`;
      });

      canvas.addEventListener("mouseleave", () => {
        tooltip.style.display = "none";
      });
    }

    function computeAdjustedSeries(series, flowPct) {
      if (!series.length) return { adjusted: [], flowEvents: 0 };
      const adjusted = [series[0]];
      let flow = 0;
      let flowEvents = 0;
      for (let i = 1; i < series.length; i++) {
        const prev = series[i - 1];
        const delta = series[i] - prev;
        const threshold = Math.max(1, prev * (flowPct / 100));
        if (Math.abs(delta) > threshold) {
          flow += delta;
          flowEvents += 1;
        }
        adjusted.push(series[i] - flow);
      }
      return { adjusted, flowEvents };
    }

    function filterHistory(history, range) {
      if (!history.length || range === "all") return history;
      const lastTs = parseTs(history[history.length - 1].ts);
      if (!lastTs) return history;
      const windowMap = {
        "7d": 7 * 24 * 60 * 60 * 1000,
        "24h": 24 * 60 * 60 * 1000,
        "6h": 6 * 60 * 60 * 1000,
        "1h": 60 * 60 * 1000
      };
      const windowMs = windowMap[range] || 0;
      if (!windowMs) return history;
      const cutoff = lastTs - windowMs;
      return history.filter(item => {
        const ts = parseTs(item.ts);
        return ts && ts >= cutoff;
      });
    }

    function healthClass(text) {
      if (!text) return "muted";
      const upper = text.toUpperCase();
      if (upper.includes("CRITICAL") || upper.includes("ERROR")) return "bad";
      if (upper.includes("WARNING") || upper.includes("WARN")) return "warn";
      if (upper.includes("HEALTHY") || upper.includes("STABLE")) return "ok";
      return "muted";
    }

    function renderSummary(items) {
      state.items = items || [];
      state.latestMap = {};
      const grid = document.getElementById("summaryGrid");
      grid.innerHTML = "";
      state.items.forEach(item => {
        if (!item || !item.symbol) return;
        state.latestMap[item.symbol] = item;
      });
      const symbols = Object.keys(state.latestMap).sort();
      document.getElementById("statusPill").textContent = `${symbols.length} symbols`;
      const subline = document.getElementById("subline");
      if (subline) {
        subline.textContent = `Active symbols: ${symbols.length} | Updated: ${new Date().toLocaleTimeString()}`;
      }
      if (!state.selected || !state.latestMap[state.selected]) {
        state.selected = symbols[0] || null;
      }
      symbols.forEach(symbol => {
        const item = state.latestMap[symbol];
        const card = document.createElement("div");
        card.className = "summary-card" + (symbol === state.selected ? " selected" : "");
        card.addEventListener("click", () => selectSymbol(symbol));

        const title = document.createElement("div");
        title.className = "summary-title";
        const label = document.createElement("div");
        label.textContent = symbol;
        const badge = document.createElement("span");
        badge.className = "badge " + (item.trade_enabled ? "ok" : "warn");
        badge.textContent = item.trade_enabled ? "ON" : "OFF";
        title.appendChild(label);
        title.appendChild(badge);
        card.appendChild(title);

        const equity = document.createElement("div");
        equity.className = "summary-value";
        equity.textContent = item.equity ? fmt(item.equity, 4) : "--";
        card.appendChild(equity);

        const rows = [
          ["Daily PnL", fmt(item.daily_pnl, 4)],
          ["Position", formatPosition(item.position)],
          ["Health", item.health?.status || "--"],
          ["OB Density", fmtPct(item.data_health?.ob_density_pct)],
          ["Lag Trade", fmtSec(item.latency?.lag_trade_sec)],
          ["Last Update", item.ts || "--"],
        ];
        rows.forEach(([k, v]) => {
          const row = document.createElement("div");
          row.className = "row";
          const left = document.createElement("span");
          left.textContent = k;
          const right = document.createElement("span");
          right.textContent = v;
          row.appendChild(left);
          row.appendChild(right);
          card.appendChild(row);
        });
        grid.appendChild(card);
      });
      if (state.selected && state.latestMap[state.selected]) {
        updateDetail(state.latestMap[state.selected]);
      }
    }

    function setView(view) {
      state.view = view;
      const accountSection = document.getElementById("accountSection");
      const tradersSection = document.getElementById("tradersSection");
      const tabAccount = document.getElementById("tabAccount");
      const tabTraders = document.getElementById("tabTraders");
      if (view === "account") {
        accountSection.classList.add("active");
        tradersSection.classList.remove("active");
        tabAccount.classList.add("active");
        tabTraders.classList.remove("active");
      } else {
        tradersSection.classList.add("active");
        accountSection.classList.remove("active");
        tabTraders.classList.add("active");
        tabAccount.classList.remove("active");
        if (state.selected) {
          fetchHistory(state.selected);
        }
      }
    }

    function formatPosition(pos) {
      if (!pos) return "--";
      const side = pos.side || "Flat";
      const size = pos.size ? Number(pos.size).toFixed(4) : "0.0000";
      return `${side} ${size}`;
    }

    function selectSymbol(symbol) {
      state.selected = symbol;
      renderSummary(state.items);
      if (symbol) {
        fetchHistory(symbol);
      }
    }

    function updateDetail(data) {
      if (!data || !data.symbol) return;
      const pos = data.position || {};
      const health = data.health || {};
      const latency = data.latency || {};
      const orders = data.orders || {};
      const rec = orders.last_reconcile || {};
      const drift = data.drift || {};
      const errors = data.errors || {};
      const dataHealth = data.data_health || {};
      const prediction = data.prediction || health.last_prediction || {};
      const model = data.model || {};
      const featureVector = data.feature_vector || {};

      document.getElementById("detailTitle").textContent = `Selected: ${data.symbol}`;
      document.getElementById("detailSub").textContent = `Startup: ${data.startup_time || "--"} | Uptime: ${Math.round(data.uptime_sec || 0)}s | Last: ${data.ts || "--"}`;
      document.getElementById("detailStatus").textContent = data.trade_enabled ? "Trading Enabled" : "Trading Paused";
      document.getElementById("detailStatus").className = "pill " + (data.trade_enabled ? "ok" : "warn");

      document.getElementById("equityVal").textContent = data.equity ? fmt(data.equity, 4) : "--";
      document.getElementById("dailyPnl").textContent = fmt(data.daily_pnl, 4);
      document.getElementById("unrealPnl").textContent = fmt(pos.unreal_pnl, 4);

      document.getElementById("posSide").textContent = pos.side || "--";
      document.getElementById("posSize").textContent = fmt(pos.size, 4);
      document.getElementById("posEntry").textContent = fmt(pos.entry_price, 6);
      document.getElementById("posMark").textContent = fmt(pos.mark_price, 6);
      document.getElementById("posTPSL").textContent = `${fmt(pos.take_profit, 6)} / ${fmt(pos.stop_loss, 6)}`;

      const healthEl = document.getElementById("healthVal");
      healthEl.textContent = health.status || "--";
      healthEl.className = "value " + healthClass(health.status);
      document.getElementById("sentimentVal").textContent = health.sentiment || "--";
      document.getElementById("regimeVal").textContent = health.regime || "--";
      document.getElementById("tradeEnabled").textContent = data.trade_enabled ? "Yes" : "No";
      const driftText = drift.alerts && drift.alerts.length ? drift.alerts.join(", ") : "None";
      document.getElementById("driftAlerts").textContent = driftText;

      document.getElementById("barsVal").textContent = dataHealth.bars || 0;
      document.getElementById("macroPct").textContent = fmtPct(dataHealth.macro_pct);
      document.getElementById("obDensity").textContent = fmtPct(dataHealth.ob_density_pct);
      document.getElementById("tradeCont").textContent = dataHealth.trade_cont ?? "--";
      document.getElementById("lagTradeBar").textContent = `${fmtSec(latency.lag_trade_sec)} / ${fmtSec(latency.lag_bar_sec)}`;

      document.getElementById("restLatency").textContent = fmtMs(latency.rest_avg_ms);
      document.getElementById("wsTrade").textContent = fmtMs(latency.ws_trade_ms);
      document.getElementById("wsOb").textContent = fmtMs(latency.ws_ob_ms);
      document.getElementById("obLag").textContent = fmtSec(latency.ob_lag_sec);

      document.getElementById("openOrders").textContent = orders.open_orders ?? 0;
      document.getElementById("lastReconcile").textContent = rec.ts || "--";
      document.getElementById("reconcileSource").textContent = rec.source || "--";
      document.getElementById("protectiveCount").textContent = rec.protective_orders ?? "--";

      document.getElementById("errorCount").textContent = `${errors.runtime_count ?? 0} / ${errors.api_count ?? 0}`;
      document.getElementById("lastRuntime").textContent = errors.last_runtime_error || "--";
      document.getElementById("lastApi").textContent = errors.last_api_error || "--";

      const predLong = prediction.pred_long;
      const predShort = prediction.pred_short;
      document.getElementById("modelPred").textContent = `${fmt(predLong, 3)} / ${fmt(predShort, 3)}`;
      document.getElementById("predLong").textContent = fmt(predLong, 3);
      document.getElementById("predShort").textContent = fmt(predShort, 3);
      document.getElementById("predThreshold").textContent = fmt(prediction.threshold, 3);
      document.getElementById("predBar").textContent = prediction.bar_time ?? "--";

      const modelPath = model.dir || "--";
      const modelPathEl = document.getElementById("modelPath");
      modelPathEl.textContent = modelPath;
      modelPathEl.title = modelPath;
      document.getElementById("keysProfile").textContent = model.keys_profile || "--";

      renderFeatures(featureVector);
    }

    function renderFeatures(featureVector) {
      const container = document.getElementById("featureList");
      container.innerHTML = "";
      const names = featureVector.names || [];
      const values = featureVector.values || [];
      if (!names.length || !values.length) {
        container.textContent = "--";
        return;
      }
      for (let i = 0; i < names.length; i++) {
        const item = document.createElement("div");
        item.className = "feature-item";
        item.textContent = `${names[i]}: ${fmt(values[i], 6)}`;
        container.appendChild(item);
      }
    }

    function renderProfiles(list) {
      const container = document.getElementById("accountProfiles");
      container.innerHTML = "";
      if (!Array.isArray(list) || !list.length) {
        container.textContent = "--";
        return;
      }
      const filtered = filterHistory(state.balanceHistory, state.balanceRange);
      const seriesMap = {};
      filtered.forEach(item => {
        if (!item || !Array.isArray(item.profiles)) return;
        item.profiles.forEach(p => {
          if (!p || !p.name) return;
          if (!seriesMap[p.name]) seriesMap[p.name] = [];
          seriesMap[p.name].push(Number(p.total_equity || 0));
        });
      });
      list.forEach(item => {
        const row = document.createElement("div");
        row.className = "profile-row";
        const left = document.createElement("div");
        left.className = "profile-meta";
        const name = document.createElement("span");
        name.textContent = item.name || "--";
        const sub = document.createElement("span");
        const unified = item.unified_equity ? fmt(item.unified_equity, 4) : "--";
        const funding = item.funding_equity ? fmt(item.funding_equity, 4) : "--";
        const fundingErr = item.funding_error ? ` | Funding: ${item.funding_error}` : "";
        sub.textContent = `U:${unified} / F:${funding}${fundingErr}`;
        left.appendChild(name);
        left.appendChild(sub);

        const right = document.createElement("div");
        right.className = "profile-metrics";
        const total = item.total_equity ? fmt(item.total_equity, 4) : "--";
        const totalEl = document.createElement("span");
        totalEl.textContent = total;
        const canvas = document.createElement("canvas");
        canvas.className = "profile-spark";
        canvas.dataset.profile = item.name || "";
        right.appendChild(totalEl);
        right.appendChild(canvas);
        row.appendChild(left);
        row.appendChild(right);
        container.appendChild(row);

        const series = seriesMap[item.name] || [];
        const trimmed = series.slice(-80).filter(v => v > 0);
        sparkline(canvas, trimmed, "#38bdf8");
      });
    }

    function updateBalances(data) {
      if (!data) return;
      state.balanceLatest = data;
      const stats = data.stats || {};
      const total = Number(data.total_equity || 0);
      const unified = Number(data.total_unified || 0);
      const funding = Number(data.total_funding || 0);
      const available = Number(data.total_available || 0);
      document.getElementById("aggBalance").textContent = total ? fmt(total, 4) : "--";
      document.getElementById("aggAvailable").textContent = available ? fmt(available, 4) : "--";
      document.getElementById("aggProfiles").textContent = data.profile_count ?? "--";
      document.getElementById("aggUnified").textContent = unified ? fmt(unified, 4) : "--";
      document.getElementById("aggFunding").textContent = funding ? fmt(funding, 4) : "--";
      document.getElementById("aggUnifiedShare").textContent = total ? `${fmt((unified / total) * 100, 1)}%` : "--";
      document.getElementById("aggFundingShare").textContent = total ? `${fmt((funding / total) * 100, 1)}%` : "--";
      document.getElementById("aggUpdated").textContent = data.ts || "--";
      document.getElementById("aggFlows").textContent = stats.flow_events ?? "--";
      const fundingStatus = document.getElementById("aggFundingStatus");
      if (fundingStatus) {
        fundingStatus.textContent = data.funding_error ? data.funding_error : "OK";
        fundingStatus.className = data.funding_error ? "bad" : "ok";
      }

      const accountSub = document.getElementById("accountSub");
      if (accountSub) {
        accountSub.textContent = `Total (Unified + Funding): ${total ? fmt(total, 4) : "--"} | Updated: ${data.ts || "--"}`;
      }
      const accountStatus = document.getElementById("accountStatus");
      if (accountStatus) {
        accountStatus.textContent = data.funding_error ? "Funding Error" : (total > 0 ? "Live" : "No Data");
      }

      document.getElementById("aggReturn").textContent = stats.total_return_pct === null || stats.total_return_pct === undefined
        ? "--"
        : `${fmt(stats.total_return_pct, 2)}%`;
      document.getElementById("aggMaxDD").textContent = stats.max_drawdown_pct === null || stats.max_drawdown_pct === undefined
        ? "--"
        : `${fmt(stats.max_drawdown_pct, 2)}%`;
      document.getElementById("aggVolatility").textContent = stats.volatility_pct === null || stats.volatility_pct === undefined
        ? "--"
        : `${fmt(stats.volatility_pct, 2)}%`;
      document.getElementById("aggStability").textContent = stats.stability_pct === null || stats.stability_pct === undefined
        ? "--"
        : `${fmt(stats.stability_pct, 1)}%`;
      document.getElementById("aggSmoothness").textContent = stats.smoothness_r2 === null || stats.smoothness_r2 === undefined
        ? "--"
        : fmt(stats.smoothness_r2, 2);
      document.getElementById("aggTrend").textContent = stats.slope_per_day === null || stats.slope_per_day === undefined
        ? "--"
        : fmt(stats.slope_per_day, 4);
      document.getElementById("aggRawReturn").textContent = stats.raw_total_return_pct === null || stats.raw_total_return_pct === undefined
        ? "--"
        : `${fmt(stats.raw_total_return_pct, 2)}%`;
      document.getElementById("aggPoints").textContent = stats.points ?? "--";

      if (stats.flow_threshold_pct) {
        state.balanceFlowPct = stats.flow_threshold_pct;
        const note = document.getElementById("balanceNote");
        if (note) {
          note.textContent = `Flow threshold: ${fmt(stats.flow_threshold_pct, 1)}% (large deposits/withdrawals removed).`;
        }
      }
      renderProfiles(data.profiles || []);
      renderBalanceHistory();
    }

    async function fetchBalances() {
      const resp = await fetch("/api/balances");
      if (!resp.ok) return;
      const data = await resp.json();
      updateBalances(data);
    }

    function renderBalanceHistory() {
      const filtered = filterHistory(state.balanceHistory, state.balanceRange);
      const raw = [];
      const labels = [];
      filtered.forEach(item => {
        const val = Number(item.total_equity || 0);
        if (val > 0) {
          raw.push(val);
          labels.push(item.ts);
        }
      });
      const { adjusted, flowEvents } = computeAdjustedSeries(raw, state.balanceFlowPct);
      state.balancePlot = { raw, adjusted, labels, flowEvents };
      drawBalanceChart(
        document.getElementById("balanceChart"),
        raw,
        adjusted,
        state.balanceScale,
        state.balanceShowRaw,
        state.balanceShowAdjusted,
      );
      if (state.balanceLatest) {
        renderProfiles(state.balanceLatest.profiles || []);
      }
      updateLegendVisibility();
    }

    function updateLegendVisibility() {
      const rawLabel = document.querySelector(".legend .raw");
      const adjLabel = document.querySelector(".legend .adjusted");
      if (rawLabel) {
        rawLabel.classList.toggle("inactive", !state.balanceShowRaw);
      }
      if (adjLabel) {
        adjLabel.classList.toggle("inactive", !state.balanceShowAdjusted);
      }
    }

    async function fetchBalanceHistory() {
      const resp = await fetch("/api/balance_history?limit=10000");
      if (!resp.ok) return;
      const data = await resp.json();
      state.balanceHistory = data || [];
      renderBalanceHistory();
    }

    async function fetchSummary() {
      const resp = await fetch("/api/summary");
      if (!resp.ok) return;
      const items = await resp.json();
      renderSummary(items || []);
    }

    async function fetchHistory(symbol) {
      if (!symbol) return;
      const resp = await fetch(`/api/metrics?symbol=${encodeURIComponent(symbol)}&limit=200`);
      if (!resp.ok) return;
      const data = await resp.json();
      const equity = data.map(x => Number(x.equity || 0));
      const latency = data.map(x => Number(x.latency?.rest_avg_ms || 0));
      sparkline(document.getElementById("equityChart"), equity, "#22c55e");
      sparkline(document.getElementById("latencyChart"), latency, "#f59e0b");
      state.lastHistorySymbol = symbol;
    }

    fetchSummary();
    fetchBalances();
    fetchBalanceHistory();
    setupBalanceTooltip();
    setInterval(fetchSummary, 2000);
    setInterval(fetchBalances, 5000);
    setInterval(fetchBalanceHistory, 15000);
    setInterval(() => {
      if (state.selected) {
        fetchHistory(state.selected);
      }
    }, 10000);

    document.getElementById("tabAccount").addEventListener("click", () => setView("account"));
    document.getElementById("tabTraders").addEventListener("click", () => setView("traders"));

    document.querySelectorAll("#balanceRange .range-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("#balanceRange .range-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        state.balanceRange = btn.dataset.range || "all";
        renderBalanceHistory();
      });
    });

    document.querySelectorAll("#balanceScale .range-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll("#balanceScale .range-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        state.balanceScale = btn.dataset.scale || "shared";
        renderBalanceHistory();
      });
    });

    document.querySelectorAll("#balanceToggle .toggle-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.toggle;
        if (!type) return;
        const key = type === "raw" ? "balanceShowRaw" : "balanceShowAdjusted";
        state[key] = !state[key];
        btn.classList.toggle("active", state[key]);
        renderBalanceHistory();
      });
    });

    setView(state.view);
  </script>
</body>
</html>
