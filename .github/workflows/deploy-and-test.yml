# Sofia LightGBM - Deploy and Test Pipeline
#
# This workflow deploys to Azure VM and runs tests, showing results in GitHub Actions
# No SSH login required - results appear in the GitHub Actions console/summary
#
# SETUP REQUIRED - Add these secrets in GitHub repo settings:
#   AZURE_VM_HOST     - IP or hostname of your Azure VM
#   AZURE_VM_USER     - SSH username
#   AZURE_VM_SSH_KEY  - Private SSH key for authentication
#   AZURE_VM_PATH     - Path on VM where Sofia is deployed (e.g., /home/user/sofia)

name: Deploy and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger from GitHub UI
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'backtest'
        type: choice
        options:
          - backtest
          - full
          - quick

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ===========================================================================
  # Job 1: Lint and Basic Checks (runs on GitHub)
  # ===========================================================================
  lint:
    name: Lint & Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint

      - name: Syntax check (flake8)
        run: |
          # Stop build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        continue-on-error: true

      - name: Check imports
        run: |
          python -c "
          import ast
          import sys
          from pathlib import Path

          errors = []
          for py_file in Path('.').glob('*.py'):
              try:
                  ast.parse(py_file.read_text(encoding='utf-8'))
                  print(f'✓ {py_file}')
              except SyntaxError as e:
                  errors.append(f'✗ {py_file}: {e}')
                  print(f'✗ {py_file}: {e}')

          if errors:
              sys.exit(1)
          "

  # ===========================================================================
  # Job 2: Deploy to Azure VM
  # ===========================================================================
  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    outputs:
      deployment_status: ${{ steps.deploy.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_VM_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to Azure VM
        id: deploy
        run: |
          echo "::group::Syncing code to Azure VM"

          # Create deployment script
          cat << 'DEPLOY_SCRIPT' > deploy.sh
          #!/bin/bash
          set -e

          DEPLOY_PATH="${AZURE_VM_PATH:-/home/$USER/sofia}"

          # Create directory if not exists
          mkdir -p "$DEPLOY_PATH"
          cd "$DEPLOY_PATH"

          # Pull latest changes or clone
          if [ -d ".git" ]; then
            git fetch origin
            git reset --hard origin/main
          else
            git clone https://github.com/${{ github.repository }}.git .
          fi

          # Create virtual environment if it doesn't exist
          if [ ! -d "venv" ]; then
            echo "Creating virtual environment..."
            python3 -m venv venv
          fi

          # Activate virtual environment and install dependencies
          source venv/bin/activate
          pip install --upgrade pip --quiet
          pip install -r requirements.txt --quiet

          echo "Deployment completed at $(date)"
          echo "Virtual environment: $DEPLOY_PATH/venv"
          DEPLOY_SCRIPT

          # Copy and execute
          scp deploy.sh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }}:/tmp/
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} "AZURE_VM_PATH='${{ secrets.AZURE_VM_PATH }}' bash /tmp/deploy.sh"

          echo "status=success" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Target | ${{ secrets.AZURE_VM_HOST }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Success |" >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 3: Run Tests on Azure VM
  # ===========================================================================
  test:
    name: Run Tests on Azure VM
    runs-on: ubuntu-latest
    needs: deploy
    if: needs.deploy.outputs.deployment_status == 'success'

    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AZURE_VM_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AZURE_VM_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Run Tests
        id: run_tests
        run: |
          TEST_TYPE="${{ github.event.inputs.test_type || 'backtest' }}"

          echo "::group::Running $TEST_TYPE tests on Azure VM"

          # Create test runner script
          cat << 'TEST_SCRIPT' > run_tests.sh
          #!/bin/bash
          set -e

          DEPLOY_PATH="${AZURE_VM_PATH:-/home/$USER/sofia}"
          cd "$DEPLOY_PATH"

          # Activate virtual environment
          source venv/bin/activate

          TEST_TYPE="$1"
          RESULTS_FILE="/tmp/sofia_test_results.txt"

          echo "=== Sofia Test Run ===" > "$RESULTS_FILE"
          echo "Date: $(date)" >> "$RESULTS_FILE"
          echo "Test Type: $TEST_TYPE" >> "$RESULTS_FILE"
          echo "========================" >> "$RESULTS_FILE"
          echo "" >> "$RESULTS_FILE"

          case "$TEST_TYPE" in
            backtest)
              echo "Running backtest..." >> "$RESULTS_FILE"
              python backtest.py --quick 2>&1 | tee -a "$RESULTS_FILE" || true
              ;;
            quick)
              echo "Running quick validation..." >> "$RESULTS_FILE"
              python -c "
          import sys
          sys.path.insert(0, '.')

          print('Checking imports...')
          try:
              import config
              import data_loader
              import feature_engine
              import models
              import predictor
              print('All core imports successful')
          except Exception as e:
              print(f'Import error: {e}')
              sys.exit(1)
          " 2>&1 | tee -a "$RESULTS_FILE"
              ;;
            full)
              echo "Running full test suite..." >> "$RESULTS_FILE"
              python train.py --test-only 2>&1 | tee -a "$RESULTS_FILE" || true
              python backtest.py 2>&1 | tee -a "$RESULTS_FILE" || true
              ;;
          esac

          echo "" >> "$RESULTS_FILE"
          echo "=== Test Complete ===" >> "$RESULTS_FILE"

          cat "$RESULTS_FILE"
          TEST_SCRIPT

          # Copy and execute test script
          scp run_tests.sh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }}:/tmp/
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_HOST }} \
            "AZURE_VM_PATH='${{ secrets.AZURE_VM_PATH }}' bash /tmp/run_tests.sh '$TEST_TYPE'" \
            2>&1 | tee test_output.txt

          echo "::endgroup::"

          # Save output for summary
          echo 'TEST_OUTPUT<<EOF' >> $GITHUB_ENV
          cat test_output.txt >> $GITHUB_ENV
          echo 'EOF' >> $GITHUB_ENV

      - name: Test Results Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Output" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat test_output.txt >> $GITHUB_STEP_SUMMARY || echo "No output captured" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: test_output.txt
          retention-days: 30

  # ===========================================================================
  # Job 4: Notify Results
  # ===========================================================================
  notify:
    name: Results Notification
    runs-on: ubuntu-latest
    needs: [deploy, test]
    if: always()

    steps:
      - name: Create Final Summary
        run: |
          echo "# Sofia Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Test | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
